<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - P√°gina de Pagamento</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .log { background: #f8f9fa; padding: 15px; border-left: 4px solid #007cba; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico do Sistema de Ingressos</h1>
        
        <div id="results"></div>
        
        <h3>Testes Dispon√≠veis:</h3>
        <button onclick="testBackend()">1. Testar Backend</button>
        <button onclick="testLogin()">2. Verificar Login</button>
        <button onclick="testEvent()">3. Buscar Evento</button>
        <button onclick="testTicketCheck()">4. Verificar Ingresso</button>
        <button onclick="testPurchase()">5. Testar Compra</button>
        <button onclick="runAllTests()">üöÄ Executar Todos</button>
        
        <h3>Log de Execu√ß√£o:</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let logDiv;
        let resultsDiv;
        
        function init() {
            logDiv = document.getElementById('log');
            resultsDiv = document.getElementById('results');
            log('üöÄ Sistema de diagn√≥stico iniciado');
            log('üìç URL atual: ' + window.location.href);
        }
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            if (logDiv) {
                logDiv.textContent += logMessage + '\n';
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }
        
        function showResult(title, success, message) {
            const statusClass = success ? 'success' : 'error';
            const icon = success ? '‚úÖ' : '‚ùå';
            const html = `<div class="status ${statusClass}"><strong>${icon} ${title}</strong><br>${message}</div>`;
            resultsDiv.innerHTML += html;
        }
        
        async function testBackend() {
            log('üß™ Testando conex√£o com backend...');
            try {
                const response = await fetch('http://localhost:3000/api/teste');
                const data = await response.json();
                log('‚úÖ Backend respondeu: ' + JSON.stringify(data));
                showResult('Backend', true, 'Servidor backend est√° funcionando corretamente');
                return true;
            } catch (error) {
                log('‚ùå Erro no backend: ' + error.message);
                showResult('Backend', false, 'Servidor backend n√£o est√° respondendo: ' + error.message);
                return false;
            }
        }
        
        function testLogin() {
            log('üß™ Verificando login do usu√°rio...');
            const usuario = localStorage.getItem('usuario');
            if (usuario) {
                try {
                    const user = JSON.parse(usuario);
                    log('‚úÖ Usu√°rio logado: ' + JSON.stringify(user));
                    showResult('Login', true, `Usu√°rio logado: ${user.email || user.nome || 'ID: ' + user.id}`);
                    return user;
                } catch (error) {
                    log('‚ùå Erro ao parsear dados do usu√°rio: ' + error.message);
                    showResult('Login', false, 'Dados de usu√°rio corrompidos no localStorage');
                    return null;
                }
            } else {
                log('‚ùå Usu√°rio n√£o est√° logado');
                showResult('Login', false, 'Usu√°rio n√£o est√° logado. Fa√ßa login primeiro.');
                return null;
            }
        }
        
        async function testEvent() {
            log('üß™ Testando busca de evento...');
            const eventoId = new URLSearchParams(window.location.search).get('eventoId') || '16';
            log('üîç Buscando evento ID: ' + eventoId);
            
            try {
                const response = await fetch(`http://localhost:3000/api/eventos/${eventoId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const evento = await response.json();
                log('‚úÖ Evento encontrado: ' + JSON.stringify(evento));
                showResult('Evento', true, `Evento encontrado: "${evento.titulo}" - R$ ${evento.preco || 0}`);
                return evento;
            } catch (error) {
                log('‚ùå Erro ao buscar evento: ' + error.message);
                showResult('Evento', false, 'Erro ao buscar evento: ' + error.message);
                return null;
            }
        }
        
        async function testTicketCheck() {
            log('üß™ Testando verifica√ß√£o de ingresso existente...');
            const user = testLogin();
            if (!user) {
                showResult('Verifica√ß√£o Ingresso', false, 'Usu√°rio n√£o est√° logado');
                return false;
            }
            
            const eventoId = new URLSearchParams(window.location.search).get('eventoId') || '16';
            
            try {
                const response = await fetch(`http://localhost:3000/api/ingressos/verificar/${user.id}/${eventoId}`);
                const data = await response.json();
                log('üìä Verifica√ß√£o: ' + JSON.stringify(data));
                
                if (data.temIngresso) {
                    showResult('Verifica√ß√£o Ingresso', false, 'BLOQUEADO: Voc√™ j√° possui um ingresso para este evento');
                    return false;
                } else {
                    showResult('Verifica√ß√£o Ingresso', true, 'OK: Voc√™ pode comprar um ingresso para este evento');
                    return true;
                }
            } catch (error) {
                log('‚ùå Erro na verifica√ß√£o: ' + error.message);
                showResult('Verifica√ß√£o Ingresso', false, 'Erro na verifica√ß√£o: ' + error.message);
                return false;
            }
        }
        
        async function testPurchase() {
            log('üß™ Testando compra de ingresso...');
            const user = testLogin();
            if (!user) {
                showResult('Compra', false, 'Usu√°rio n√£o est√° logado');
                return false;
            }
            
            const eventoId = new URLSearchParams(window.location.search).get('eventoId') || '16';
            
            // Verificar se j√° possui ingresso primeiro
            const canPurchase = await testTicketCheck();
            if (!canPurchase) {
                return false;
            }
            
            const ingressoData = {
                usuarioId: user.id,
                eventoId: parseInt(eventoId),
                preco: 100.00,
                formaPagamento: 'Cart√£o de Cr√©dito (Teste)'
            };
            
            log('üí≥ Tentando criar ingresso: ' + JSON.stringify(ingressoData));
            
            try {
                const response = await fetch('http://localhost:3000/api/ingressos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(ingressoData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const ingresso = await response.json();
                log('‚úÖ Ingresso criado: ' + JSON.stringify(ingresso));
                showResult('Compra', true, `Ingresso criado com sucesso! C√≥digo: ${ingresso.codigo}`);
                return ingresso;
            } catch (error) {
                log('‚ùå Erro na compra: ' + error.message);
                showResult('Compra', false, 'Erro na compra: ' + error.message);
                return null;
            }
        }
        
        async function runAllTests() {
            resultsDiv.innerHTML = '';
            log('\nüîÑ === INICIANDO TODOS OS TESTES ===');
            
            const backendOk = await testBackend();
            if (!backendOk) {
                log('‚õî Parando testes - backend n√£o dispon√≠vel');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            const user = testLogin();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            const event = await testEvent();
            
            if (user && event) {
                await new Promise(resolve => setTimeout(resolve, 500));
                await testTicketCheck();
            }
            
            log('üèÅ === TESTES CONCLU√çDOS ===\n');
        }
        
        // Executar ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Auto-executar teste b√°sico
            setTimeout(() => {
                log('üîÑ Executando teste autom√°tico...');
                runAllTests();
            }, 1000);
        });
    </script>
</body>
</html>